import{r as o,p as a,q as c,w as r,B as l,P as e}from"./vendor.62143b15.js";const u=l("div",{class:"markdown-body"},[l("blockquote",null,[l("p",null,"Custom API Hooks allow running custom logic when a specified event occurs within your project. They can be registered as either \u201Cblocking\u201D or immediate.")]),l("h2",{id:"1.-create-a-hook-file"},[e("1. Create a Hook File "),l("a",{class:"header-anchor",href:"#1.-create-a-hook-file"},"#")]),l("p",null,[e("Custom hooks are dynamically loaded from within your extensions folder. By default this directory is located at "),l("code",null,"/extensions"),e(", but it can be configured within your project\u2019s env file to be located anywhere.")]),l("h3",{id:"default-standalone-hook-location"},[e("Default Standalone Hook Location "),l("a",{class:"header-anchor",href:"#default-standalone-hook-location"},"#")]),l("pre",null,[l("code",null,`/extensions/hooks/<hook-id>/index.js
`)]),l("h2",{id:"2.-define-the-event"},[e("2. Define the Event "),l("a",{class:"header-anchor",href:"#2.-define-the-event"},"#")]),l("p",null,"Next, you will want to define your event. You can trigger your custom hook with any of the platform\u2019s many API events. System events are referenced with the format:"),l("pre",null,[l("code",null,`<scope>.<action>(.<before>)
// eg: items.create
// eg: files.upload
// eg: collections.*
// eg: users.update.before
`)]),l("h3",{id:"scope"},[e("Scope "),l("a",{class:"header-anchor",href:"#scope"},"#")]),l("p",null,[e("The scope determines the API endpoint that is triggered. The "),l("code",null,"*"),e(" wildcard can also be used to include all scopes.")]),l("div",{class:"tip hint"},[l("div",{class:"hint-title"},"System Scope"),l("p",null,[e("Currently all system tables are available as event scopes except for "),l("code",null,"directus_migrations"),e(" and "),l("code",null,"directus_sessions"),e(", which don\u2019t have relevant endpoints or services.")])]),l("h3",{id:"action"},[e("Action "),l("a",{class:"header-anchor",href:"#action"},"#")]),l("p",null,[e("Defines the triggering operation within the specified context (see chart below). The "),l("code",null,"*"),e(" wildcard can also be used to include all actions available to the scope.")]),l("h3",{id:"before"},[e("Before "),l("a",{class:"header-anchor",href:"#before"},"#")]),l("p",null,[e("Many scopes (see chart below) support an optional "),l("code",null,".before"),e(" suffix for running a "),l("em",null,"blocking"),e(" hook prior to the event being fired. This allows you to check and/or modify the event\u2019s payload before it is processed.")]),l("ul",null,[l("li",null,[l("code",null,"items.create.before"),e(" (Blocking)")]),l("li",null,[l("code",null,"items.create"),e(" (Non Blocking, also called \u2018after\u2019 implicitly)")])]),l("p",null,"This also allows you to cancel an event based on the logic within the hook. Below is an example of how you can cancel a create event by throwing a standard Directus exception."),l("pre",null,[l("code",{class:"language-js"},[l("span",{class:"hljs-built_in"},"module"),e(".exports = "),l("span",{class:"hljs-function"},[l("span",{class:"hljs-keyword"},"function"),e(),l("span",{class:"hljs-title"},"registerHook"),e("("),l("span",{class:"hljs-params"},"{ exceptions }"),e(") ")]),e(`{
	`),l("span",{class:"hljs-keyword"},"const"),e(` { InvalidPayloadException } = exceptions;

	`),l("span",{class:"hljs-keyword"},"return"),e(` {
		`),l("span",{class:"hljs-string"},"'items.create.before'"),e(": "),l("span",{class:"hljs-keyword"},"async"),e(),l("span",{class:"hljs-function"},[l("span",{class:"hljs-keyword"},"function"),e(" ("),l("span",{class:"hljs-params"},"input"),e(") ")]),e(`{
			`),l("span",{class:"hljs-keyword"},"if"),e(` (LOGIC_TO_CANCEL_EVENT) {
				`),l("span",{class:"hljs-keyword"},"throw"),e(),l("span",{class:"hljs-keyword"},"new"),e(` InvalidPayloadException(WHAT_IS_WRONG);
			}

			`),l("span",{class:"hljs-keyword"},"return"),e(` input;
		},
	};
};
`)])]),l("h3",{id:"event-format-options"},[e("Event Format Options "),l("a",{class:"header-anchor",href:"#event-format-options"},"#")]),l("table",null,[l("thead",null,[l("tr",null,[l("th",null,"Scope"),l("th",null,"Actions"),l("th",null,"Before")])]),l("tbody",null,[l("tr",null,[l("td",null,[l("code",null,"cron()")]),l("td",null,[l("a",{href:"#interval-cron"},"See below for configuration")]),l("td",null,"No")]),l("tr",null,[l("td",null,[l("code",null,"cli.init")]),l("td",null,[l("code",null,"before"),e(" and "),l("code",null,"after")]),l("td",null,"No")]),l("tr",null,[l("td",null,[l("code",null,"server")]),l("td",null,[l("code",null,"start"),e(" and "),l("code",null,"stop")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"init")]),l("td"),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"routes.init")]),l("td",null,[l("code",null,"before"),e(" and "),l("code",null,"after")]),l("td",null,"No")]),l("tr",null,[l("td",null,[l("code",null,"routes.custom.init")]),l("td",null,[l("code",null,"before"),e(" and "),l("code",null,"after")]),l("td",null,"No")]),l("tr",null,[l("td",null,[l("code",null,"middlewares.init")]),l("td",null,[l("code",null,"before"),e(" and "),l("code",null,"after")]),l("td",null,"No")]),l("tr",null,[l("td",null,[l("code",null,"request")]),l("td",null,[l("code",null,"not_found")]),l("td",null,"No")]),l("tr",null,[l("td",null,[l("code",null,"response")]),l("td"),l("td",null,[e("No"),l("sup",null,"[1]")])]),l("tr",null,[l("td",null,[l("code",null,"database.error")]),l("td",null,"When a database error is thrown"),l("td",null,"No")]),l("tr",null,[l("td",null,[l("code",null,"error")]),l("td"),l("td",null,"No")]),l("tr",null,[l("td",null,[l("code",null,"auth")]),l("td",null,[l("code",null,"login"),e(", "),l("code",null,"logout"),l("sup",null,"[1]"),e(", "),l("code",null,"jwt"),e(" and "),l("code",null,"refresh"),l("sup",null,"[1]")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"oauth.:provider"),l("sup",null,"[2]")]),l("td",null,[l("code",null,"login"),e(" and "),l("code",null,"redirect")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"items")]),l("td",null,[l("code",null,"read"),l("sup",null,"[3]"),e(", "),l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"activity")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"collections")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"fields")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"files")]),l("td",null,[l("code",null,"upload"),l("sup",null,"[3]")]),l("td",null,"No")]),l("tr",null,[l("td",null,[l("code",null,"folders")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"permissions")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"presets")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"relations")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"revisions")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"roles")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"settings")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"users")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")]),l("tr",null,[l("td",null,[l("code",null,"webhooks")]),l("td",null,[l("code",null,"create"),e(", "),l("code",null,"update"),e(" and "),l("code",null,"delete")]),l("td",null,"Optional")])])]),l("p",null,[l("sup",null,"1"),e(" Feature Coming Soon"),l("br"),l("sup",null,"2"),e(" oAuth provider name can replaced with wildcard for any oauth providers "),l("code",null,"oauth.*.login"),l("br"),l("sup",null,"3"),e(" Doesn\u2019t support "),l("code",null,".before"),e(" modifier")]),l("h4",{id:"interval-(cron)"},[e("Interval (cron) "),l("a",{class:"header-anchor",href:"#interval-(cron)"},"#")]),l("p",null,[e("Hooks support running on an interval through "),l("a",{href:"https://www.npmjs.com/package/node-cron",target:"_blank",rel:"noopener noreferrer"},[l("code",null,"node-cron")]),e(". To set this up, provide a cron statement in the event scope as follows: "),l("code",null,"cron(<statement>)"),e(", for example "),l("code",null,"cron(15 14 1 * *)"),e(" (at 14:15 on day-of-month 1) or "),l("code",null,"cron(5 4 * * sun)"),e(" (at 04:05 on Sunday). See example below:")]),l("pre",null,[l("code",{class:"language-js"},[l("span",{class:"hljs-keyword"},"const"),e(" axios = "),l("span",{class:"hljs-built_in"},"require"),e("("),l("span",{class:"hljs-string"},"'axios'"),e(`);

`),l("span",{class:"hljs-built_in"},"module"),e(".exports = "),l("span",{class:"hljs-function"},[l("span",{class:"hljs-keyword"},"function"),e(),l("span",{class:"hljs-title"},"registerHook"),e("("),l("span",{class:"hljs-params"}),e(") ")]),e(`{
	`),l("span",{class:"hljs-keyword"},"return"),e(` {
		`),l("span",{class:"hljs-string"},"'cron(*/15 * * * *)'"),e(": "),l("span",{class:"hljs-keyword"},"async"),e(),l("span",{class:"hljs-function"},[l("span",{class:"hljs-keyword"},"function"),e(" ("),l("span",{class:"hljs-params"}),e(") ")]),e(`{
			`),l("span",{class:"hljs-keyword"},"await"),e(" axios.post("),l("span",{class:"hljs-string"},"'http://example.com/webhook'"),e(", { "),l("span",{class:"hljs-attr"},"message"),e(": "),l("span",{class:"hljs-string"},"'Another 15 minutes passed...'"),e(` });
		},
	};
};
`)])]),l("h2",{id:"3.-register-your-hook"},[e("3. Register your Hook "),l("a",{class:"header-anchor",href:"#3.-register-your-hook"},"#")]),l("p",null,"Each custom hook is registered to its event scope using a function with the following format:"),l("pre",null,[l("code",{class:"language-js"},[l("span",{class:"hljs-keyword"},"const"),e(" axios = "),l("span",{class:"hljs-built_in"},"require"),e("("),l("span",{class:"hljs-string"},"'axios'"),e(`);

`),l("span",{class:"hljs-built_in"},"module"),e(".exports = "),l("span",{class:"hljs-function"},[l("span",{class:"hljs-keyword"},"function"),e(),l("span",{class:"hljs-title"},"registerHook"),e("("),l("span",{class:"hljs-params"}),e(") ")]),e(`{
	`),l("span",{class:"hljs-keyword"},"return"),e(` {
		`),l("span",{class:"hljs-string"},"'items.create'"),e(": "),l("span",{class:"hljs-function"},[l("span",{class:"hljs-keyword"},"function"),e(" ("),l("span",{class:"hljs-params"}),e(") ")]),e(`{
			axios.post(`),l("span",{class:"hljs-string"},"'http://example.com/webhook'"),e(`);
		},
	};
};
`)])]),l("h2",{id:"4.-develop-your-custom-hook"},[e("4. Develop your Custom Hook "),l("a",{class:"header-anchor",href:"#4.-develop-your-custom-hook"},"#")]),l("blockquote",null,[l("p",null,[e("Hooks can impact performance when not carefully implemented. This is especially true for "),l("code",null,"before"),e(" hooks (as these are blocking) and hooks on "),l("code",null,"read"),e(" actions, as a single request can result in a large amount of database reads.")])]),l("h3",{id:"register-function"},[e("Register Function "),l("a",{class:"header-anchor",href:"#register-function"},"#")]),l("p",null,[e("The register function (eg: "),l("code",null,"module.exports = function registerHook()"),e(") must return an object where the key is the event, and the value is the handler function itself.")]),l("p",null,[e("The "),l("code",null,"registerHook"),e(" function receives a context parameter with the following properties:")]),l("ul",null,[l("li",null,[l("code",null,"services"),e(" \u2014 All API internal services")]),l("li",null,[l("code",null,"exceptions"),e(" \u2014\xA0API exception objects that can be used for throwing \u201Cproper\u201D errors")]),l("li",null,[l("code",null,"database"),e(" \u2014 Knex instance that is connected to the current database")]),l("li",null,[l("code",null,"getSchema"),e(" \u2014 Async function that reads the full available schema for use in services")]),l("li",null,[l("code",null,"env"),e(" \u2014\xA0Parsed environment variables")]),l("li",null,[l("code",null,"logger"),e(" \u2014\xA0"),l("a",{href:"https://github.com/pinojs/pino",target:"_blank",rel:"noopener noreferrer"},"Pino"),e(" instance.")])]),l("h3",{id:"event-handler-function"},[e("Event Handler Function "),l("a",{class:"header-anchor",href:"#event-handler-function"},"#")]),l("p",null,[e("The event handler function (eg: "),l("code",null,"'items.create': function()"),e(") receives a context parameter with the following properties:")]),l("ul",null,[l("li",null,[l("code",null,"event"),e(" \u2014 Full event string")]),l("li",null,[l("code",null,"accountability"),e(" \u2014 Information about the current user")]),l("li",null,[l("code",null,"collection"),e(" \u2014 Collection that is being modified")]),l("li",null,[l("code",null,"item"),e(" \u2014\xA0Primary key(s) of the item(s) being modified")]),l("li",null,[l("code",null,"action"),e("\xA0\u2014 Action that is performed")]),l("li",null,[l("code",null,"payload"),e(" \u2014\xA0Payload of the request")]),l("li",null,[l("code",null,"schema"),e(" - The current API schema in use")]),l("li",null,[l("code",null,"database"),e(" - Current database transaction")])]),l("div",{class:"tip hint"},[l("div",{class:"hint-title"},"Input"),l("p",null,[e("The "),l("code",null,"items.*.before"),e(" hooks get the raw input payload as the first parameter, with the context parameter as the second parameter.")])]),l("h4",{id:"items-read"},[e("Items read "),l("a",{class:"header-anchor",href:"#items-read"},"#")]),l("p",null,[e("In contrast to the other "),l("code",null,"items"),e(" events ("),l("code",null,"items.create"),e(", "),l("code",null,"items.update"),e(", "),l("code",null,"items.delete"),e(") the "),l("code",null,"items.read"),e(" doesn\u2019t receive the primary key(s) of the items but the query used:")]),l("ul",null,[l("li",null,[l("code",null,"event"),e(" \u2014 Full event string")]),l("li",null,[l("code",null,"accountability"),e(" \u2014 Information about the current user")]),l("li",null,[l("code",null,"collection"),e(" \u2014 Collection that is being modified")]),l("li",null,[l("code",null,"query"),e(" \u2014\xA0The query used to get the data")]),l("li",null,[l("code",null,"action"),e("\xA0\u2014 Action that is performed")]),l("li",null,[l("code",null,"payload"),e(" \u2014\xA0Payload of the request")]),l("li",null,[l("code",null,"schema"),e(" - The current API schema in use")]),l("li",null,[l("code",null,"database"),e(" - Current database transaction")])]),l("h4",{id:"auth"},[e("Auth "),l("a",{class:"header-anchor",href:"#auth"},"#")]),l("p",null,[e("The "),l("code",null,"auth"),e(" and "),l("code",null,"oauth"),e(" hooks have the following context properties:")]),l("ul",null,[l("li",null,[l("code",null,"event"),e(" \u2014 Full event string")]),l("li",null,[l("code",null,"accountability"),e(" \u2014 Information about the current user")]),l("li",null,[l("code",null,"action"),e("\xA0\u2014 Action that is performed")]),l("li",null,[l("code",null,"payload"),e(" \u2014\xA0Payload of the request")]),l("li",null,[l("code",null,"schema"),e(" - The current API schema in use")]),l("li",null,[l("code",null,"status"),e(" - One of "),l("code",null,"pending"),e(", "),l("code",null,"success"),e(", "),l("code",null,"fail")]),l("li",null,[l("code",null,"user"),e(),l("sup",null,"\u2020"),e(" - ID of the user that tried logging in/has logged in")])]),l("p",null,[l("sup",null,"\u2020"),e(" Not available in "),l("code",null,"oauth")]),l("h2",{id:"5.-restart-the-api"},[e("5. Restart the API "),l("a",{class:"header-anchor",href:"#5.-restart-the-api"},"#")]),l("p",null,"To deploy your hook, simply restart the API by running:"),l("pre",null,[l("code",{class:"language-bash"},`npx directus start
`)]),l("h2",{id:"full-example"},[e("Full Example "),l("a",{class:"header-anchor",href:"#full-example"},"#")]),l("p",null,[l("code",null,"extensions/hooks/sync-with-external/index.js"),e(":")]),l("pre",null,[l("code",{class:"language-js"},[l("span",{class:"hljs-keyword"},"const"),e(" axios = "),l("span",{class:"hljs-built_in"},"require"),e("("),l("span",{class:"hljs-string"},"'axios'"),e(`);

`),l("span",{class:"hljs-built_in"},"module"),e(".exports = "),l("span",{class:"hljs-function"},[l("span",{class:"hljs-keyword"},"function"),e(),l("span",{class:"hljs-title"},"registerHook"),e("("),l("span",{class:"hljs-params"},"{ services, exceptions }"),e(") ")]),e(`{
	`),l("span",{class:"hljs-keyword"},"const"),e(` { MailService } = services;
	`),l("span",{class:"hljs-keyword"},"const"),e(` { ServiceUnavailableException, ForbiddenException } = exceptions;

	`),l("span",{class:"hljs-keyword"},"return"),e(` {
		`),l("span",{class:"hljs-comment"},"// Force everything to be admin-only at all times"),e(`
		`),l("span",{class:"hljs-string"},"'items.*'"),e(": "),l("span",{class:"hljs-keyword"},"async"),e(),l("span",{class:"hljs-function"},[l("span",{class:"hljs-keyword"},"function"),e(" ("),l("span",{class:"hljs-params"},"{ item, accountability }"),e(") ")]),e(`{
			`),l("span",{class:"hljs-keyword"},"if"),e(" (accountability.admin !== "),l("span",{class:"hljs-literal"},"true"),e(") "),l("span",{class:"hljs-keyword"},"throw"),e(),l("span",{class:"hljs-keyword"},"new"),e(` ForbiddenException();
		},
		`),l("span",{class:"hljs-comment"},"// Sync with external recipes service, cancel creation on failure"),e(`
		`),l("span",{class:"hljs-string"},"'items.create.before'"),e(": "),l("span",{class:"hljs-keyword"},"async"),e(),l("span",{class:"hljs-function"},[l("span",{class:"hljs-keyword"},"function"),e(" ("),l("span",{class:"hljs-params"},"input, { collection, schema }"),e(") ")]),e(`{
			`),l("span",{class:"hljs-keyword"},"if"),e(" (collection !== "),l("span",{class:"hljs-string"},"'recipes'"),e(") "),l("span",{class:"hljs-keyword"},"return"),e(` input;

			`),l("span",{class:"hljs-keyword"},"const"),e(" mailService = "),l("span",{class:"hljs-keyword"},"new"),e(` MailService({ schema });

			`),l("span",{class:"hljs-keyword"},"try"),e(` {
				`),l("span",{class:"hljs-keyword"},"await"),e(" axios.post("),l("span",{class:"hljs-string"},"'https://example.com/recipes'"),e(`, input);
				`),l("span",{class:"hljs-keyword"},"await"),e(` mailService.send({
					`),l("span",{class:"hljs-attr"},"to"),e(": "),l("span",{class:"hljs-string"},"'person@example.com'"),e(`,
					`),l("span",{class:"hljs-attr"},"template"),e(`: {
						`),l("span",{class:"hljs-attr"},"name"),e(": "),l("span",{class:"hljs-string"},"'item-created'"),e(`,
						`),l("span",{class:"hljs-attr"},"data"),e(`: {
							`),l("span",{class:"hljs-attr"},"collection"),e(`: collection,
						},
					},
				});
			} `),l("span",{class:"hljs-keyword"},"catch"),e(` (error) {
				`),l("span",{class:"hljs-keyword"},"throw"),e(),l("span",{class:"hljs-keyword"},"new"),e(` ServiceUnavailableException(error);
			}

			input[`),l("span",{class:"hljs-number"},"0"),e("].syncedWithExample = "),l("span",{class:"hljs-literal"},"true"),e(`;

			`),l("span",{class:"hljs-keyword"},"return"),e(` input;
		},
	};
};
`)])])],-1),f={setup(d,{expose:t}){const n={title:"Custom API Hooks",modularExtension:!0};return t({frontmatter:n}),(i,h)=>{const s=o("DocsWrapper");return a(),c(s,{frontmatter:n},{default:r(()=>[u]),_:1})}}};export{f as default};
